---
title: 'Title'
author : 'Team: Code Go Gold'
output: html_document
---
## Introduction

##### A research conducted by David Popenoe, a sociologist at Rutgers University, asserted that fifty percent of marriages will end in divorce. Actually, divorce is both very personal and all too common. But there are many myths about divorce. Therefore, in this markdown we mainly focus on the divorce rate in the United States, as well we would provide some simple tips or advice to the next generations. 


## Set the environment
```{r lib, message=F, include=T}
# add all the lib you use
library(rMaps)
library(data.table)
library("FactoMineR")
library("factoextra")
library("gplots")
library(sunburstR)
library(TraMineR)
library(pipeR)
library(RColorBrewer)
library(stringr)
library(data.table)
library(plyr)
library(ggplot2)
library(plotly)

```

## General Picture of the Divorce Rate
```{r code = ichoropleth, echo=F, message=F, include=F}
path = '/Users/pengfeiwang/Desktop/Fall2016-proj1-grp8/output/Divorce_Rate/Divorce_rate_total.csv'
rate = fread(path)
rate = subset(rate, Year != 2014)
r1 = ichoropleth(Divorce_Rate ~ State, ncuts =5, rate, animate = "Year", legend = FALSE)
r1$save(destfile = 'general.html')
```

```{r viz, echo=FALSE}
# htmltools::includeHTML("file:///Users/pengfeiwang/Desktop/Fall2016-proj1-grp8/figs/general.html")
```

###### This choropleth encodes divorce rates per 1000 population for successive 12-monthe period from 2008 with a quantize scale ranging from 0 to 11%. As we can see, the divorce rate is continuously decreasing for almost half decade in every states. However, the absolute value remains very high.



###### The following part is a general summary of of the relationsip between marriage times and education levels. Here, education level is accounted as one's highest degree. In the first ballon fig, we can see that in every education level, those who has never divorced accunt for the largest group. Also, the trend are the same: population decreases as the divorce time increases. But one interesting thing is that the "never divorce" and "divorce once" group sizes in Low education and Master level are almost the same. However, the "divorce twice" and ">3 time divorce" groups in Low education level are much larger than they are in Master level.


## Education / Major
```{r code, echo=F, message=F, include=F}
# Chencheng's Part
#setwd("~/Documents/Courses/ADS/Project 1")
# data cleansing
colstokeep_pus <- c("AGEP", "MSP", "MARHT", "SCHL", "FOD1P", "SCIENGRLP")
dataset_a <- fread('csv_pus/ss14pusa.csv', select= colstokeep_pus)
dataset_b <- fread('csv_pus/ss14pusb.csv', select= colstokeep_pus)
data.fm<- data.frame(rbind(dataset_a, dataset_b)[AGEP >18,])
data.fm <- data.fm[!is.na(data.fm[,"MARHT"]),]
data.fm$DIV=data.fm$MARHT-1
data.fm$DIV[data.fm$MSP==4]=data.fm$DIV[data.fm$MSP==4]+1
data.fm[is.na(data.fm)] <- 0

#####################################################
# education level calculation
lowedu= subset(data.fm, SCHL<=15) #lower than high school
highschool= subset(data.fm, SCHL>= 16 & SCHL<= 20) #including high school, GED, Associate's degree or enter the college without degree
bachelor= subset(data.fm, SCHL==21) 
master= subset(data.fm, SCHL==22| SCHL ==23) #including master and professional degree
phd= subset(data.fm, SCHL==24)
data_edu= list(lowedu,highschool,bachelor, master, phd)

#####################################################
# generate marry-education matrix
div_edu= matrix(nrow=5,ncol=4)
rownames(div_edu) <- c("Low education", "High school", "Bachelor", "Master", "PhD")
colnames(div_edu) <- c("Never", "Once", "Twice", ">3 times")
for(i in 1:5){
  for(j in 1:4){
    div_edu[i,j]= nrow(subset(data_edu[[i]],DIV == j-1))
  }
}

```

```{r balloonplot, echo=T}
# draw the balloonplot
balloonplot(data = t(as.table(div_edu)), 
            main ="Divorce and Education level", 
            xlab ="Divorce", ylab="Education level",
            dotsize = 8, text.size= 0.7, label = F, 
            show.margins = FALSE)
```

```{r sunburst_code, echo=F, message=F, include=F}
# draw the sunburst plot
edu= subset(data.fm, select= c("DIV","SCHL","SCIENGRLP"))
edu[,1]= sapply(edu[,1], paste, "time(s)")
edu_test= edu ## mark ##
for(i in 1:nrow(edu_test)){
  if(edu_test[i,2]<15){
    edu_test[i,2]="Lowedu"
  }else if(edu_test[i,2]>=16 & edu_test[i,2]<=20){
    edu_test[i,2]="Highschool"
  }else if(edu_test[i,2]==21){
    edu_test[i,2]="Bachelor"
  }else if(edu_test[i,2]==22|edu_test[i,2]==23){
    edu_test[i,2]="Master"
  }else{
    edu_test[i,2]="PhD"
  }
}

#prepare for the sunburst plot
edu.seq <- seqdef(edu_test)
sun_edu=seqtab(edu.seq, tlim = 0, format = "STS" )
name=names(attributes(as.list(sun_edu))$weights)
freq=as.numeric(attributes(as.list(sun_edu))$freq[,2])
sun_edu.fm=data.frame(name,freq)
sun_edu.fm[,1]= str_replace_all(sun_edu.fm[,1],"-0"," ")
sun_edu.fm[,1]= str_replace_all(sun_edu.fm[,1],"-1","-STEM")
sun_edu.fm[,1]= str_replace_all(sun_edu.fm[,1],"-2","-Non_STEM")

cols=c(brewer.pal(6,"Set2"),brewer.pal(6,"Set3"))
sunburst(sun_edu.fm,colors=cols)
```

###### For the sunburst fig, the innermost circle shows proportion of different divorce times, the middel circle shows the education level, and the outermost circle shows the major, whether it's STEM or not. As we can see, the never divorced group accounts for 64% of the total married people. For most of us, who are master of STEM students, stays in blue-light orange part. So we probably end up with never divorce or divorce once (never divorce 0.758%, divorce once 0.254%) but will never divorce more than twice

```{r sunburst, echo=T}
# add the link to the html

```



## Useful data extraction

Read in the useful columns. 

```{r, message=FALSE, warning=FALSE}
# Minghao's Part
colstokeep_time <- c("MARHD", "MARHM", "JWAP", "JWDP", "SEX", "AEGP", "PERNP", "RAC1P", "ST")
T1 <- fread('ss13pusa.csv', select = colstokeep_time, na.strings = c("bbb", "bbbbbbb"))
T2 <- fread('ss13pusb.csv', select = colstokeep_time, na.strings = c("bbb", "bbbbbbb"))
Tfull <- rbind(T1, T2)
Tuse <- na.omit(Tfull)
```

## Time of arrival at work and Sex

```{r, message=FALSE, warning=FALSE}
Tuse$SEX <- as.factor(Tuse$SEX)

Tuse$JWAP_h <- ifelse(Tuse$JWAP %in% c(1:10), 0, 
                      ifelse(Tuse$JWAP %in% c(11,21), 1, 
                             ((Tuse$JWAP-22) %/% 12) + 2))

findrate <- function(x) sum(x==1)/length(x)
rate_arr <- ddply(Tuse, .(JWAP_h, SEX), summarize, 
            n = length(MARHD), drate = findrate(MARHD), mrate = findrate(MARHM))


hour_sex_marry <- ggplot(rate_arr, aes(x = factor(JWAP_h), y = mrate, fill=SEX)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.8)+  
  coord_polar(theta = "x", start = -0.13)+
  xlab("Time arrival at work") + ylab("Marriage rate")+
  labs(title = "Marriage rate vs Time arrival at work (in hour)")+
  scale_fill_discrete(labels=c("Male", "Female"))+
  theme(legend.justification=c(1,0), legend.position=c(1,0), 
        text = element_text(size=15))

hour_sex_marry  
  
hour_sex_divorce <- ggplot(rate_arr, aes(x = factor(JWAP_h), y = drate, fill=SEX)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.8)+ 
  coord_polar(theta = "x", start = -0.13)+
  xlab("Time arrival at work") + ylab("Divorce rate")+
  labs(title = "Divorce rate vs Time arrival at work (in hour)")+
  scale_fill_discrete(labels=c("Male", "Female"))+
  theme(legend.justification=c(1,0), legend.position=c(1,0), 
        text = element_text(size=15))

hour_sex_divorce

```

The number on the outer circle is the time arrival at work from 0 am to 23 pm, the height of each bar refers to the marriage/divorce rate in the two plots. 

1. From the marriage rate plot, men usually have higher marriage rates than women, especially for the men who arrive at 11-16. On the other hand, from the divorce rate plot, women usually have higher divorce rate than men. Unfortunately, This implies that women are more likely to divorce and hardly to marry than men. 

2. In the divorce rate plot, the women who work from 1 am have the largest divorce rate. This makes sense, but the other reason for this is that compared with the persons who work from 7 am - 9 am, there are far fewer persons who work at midnight, so the variance is much bigger and the rate is sensitive to outliers. 

3. Comparing this two plots, for the persons who work from regular time (7am - 9am), they have smaller marriage rate as well as smaller divorce rate than persons working from other time. This implies that people with a steady work are also likely have a steady marriage. 

## Earning and Sex
```{r, message=FALSE, warning=FALSE}
Tuse$earning <- ifelse(Tuse$PERNP %in% c(-9000:0), 0, 
                ifelse(Tuse$PERNP %in% c(0:104000), round(Tuse$PERNP/10000), 
                ifelse(Tuse$PERNP %in% c(104000:504000), "10-50", "50+")))
Tuse$earning <- factor(Tuse$earning, levels=c(as.character(0:10), "10-50", "50+"))

rate_earn <- ddply(Tuse, .(earning, SEX), summarize, 
                  n = length(MARHD), drate = findrate(MARHD), mrate = findrate(MARHM))

rate_earn_transfer <- rbind(data.frame(type="marry", rate_earn[, c(1:3)], rate=rate_earn[,5]),
                            data.frame(type="divorce", rate_earn[, c(1:3)], rate=-rate_earn[,4]))

earn_sex <- ggplot(rate_earn_transfer, 
  aes(x = earning, y = rate, group = SEX, fill = SEX)) +
  geom_bar(stat = "identity", position = "dodge", alpha = 0.8)+ 
  geom_hline(yintercept = 0)+
  xlab("Total person's earnings (in 10k dollars)") + ylab("Marriage and Divorce rate")+
  labs(title = "Marriage and Divorce rate vs Total person's earning (in $10k)")+
  scale_fill_discrete(labels=c("Male", "Female"))+
  theme(legend.justification=c(1,1), legend.position=c(1,1), 
        text = element_text(size=15))
earn_sex

```

The x axis represents the personal earnings, the barplot above x axis refers to the marriage rate, and the below part refers to the divorce rate. 

1. It's reasonable to see that for all earning levels and each sex, the marriage rate is always larger than the divorce rate. 

2. The more people's earning, the smaller their marriage and divorce rate. This makes sense, since the people with a steady work are also likely have a steady marriage. 

3. The men with lower earnings (10k - 30k) are more likely to marry than a women with same earnings. This may imply that women don't look down on men who have lower earning, and at the same time, the men with lower earning have more free time and they are more likely to find a partner and get married


## Race and Region
```{r, message=FALSE, warning=FALSE}
Tuse$race <- as.factor(ifelse(Tuse$RAC1P %in% c(1,2,6,9), Tuse$RAC1P, 
             ifelse(Tuse$RAC1P %in% c(3,4,5), 3, 7)))

levels(Tuse$race) <- c("White", "Black or African American", 
                "American Indian or Alaska Native", "Asian", "Some Other Race", 
                "Two or More Races")

Tuse$state <- as.factor(ifelse(Tuse$ST == 11, 24, Tuse$ST))

levels(Tuse$state) <- state.region

rate_race <- ddply(Tuse, .(race, state), summarize, 
             n = length(MARHD), drate = findrate(MARHD), mrate = findrate(MARHM))
rate_race$"sq_n" <- sqrt(rate_race$n)
names(rate_race)[4] <- "divorce_rate"
names(rate_race)[5] <- "marriage_rate"


plot_ly(d, x = carat, y = price, text = paste("Clarity: ", clarity),
        mode = "markers", color = carat, size = carat)

p <- plot_ly(rate_race, x = divorce_rate, y = marriage_rate, text = paste("Division: ", state), 
        mode = "markers", color = race, size = sq_n)
p %>% layout(legend = list(x = 0, y = 1))

```

The x axis is divorce rate, the y axis is marriage rate, the color refers to different races, the size of the bubbles is proportional to square root of sample size in each category, and we also investigate different region effects. 

1. In general, the asians have the lowest divorce rate, the whites higher and the black or African American people have relatively highest divorce rate. For the other races, since there are less samples, so the variance is bigger. 

2. The asians in northeast have the lowest divorce rate, and the southern people with more than two races have the highest divorce rate.  

3. For whites, the people in northeast have the lowest marriage and divorce rate, and the southern people have the highest two rates. This might be a result of the different culture in different regions. 

## viz3
```{r}
# Kaisheng's Part

```

